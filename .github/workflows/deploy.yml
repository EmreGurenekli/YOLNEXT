name: ğŸš€ Deploy YolNext Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Frontend Build and Deploy to Netlify
  frontend:
    name: ğŸ¨ Frontend Deploy (Netlify)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š Install Dependencies
      run: npm ci
      
    - name: ğŸ”§ Build Frontend
      run: npm run build:frontend
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
        
    - name: ğŸš€ Deploy to Netlify
      uses: netlify/actions/cli@master
      with:
        args: deploy --prod --dir=dist
      env:
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

  # Backend Health Check
  backend-check:
    name: ğŸ” Backend Health Check
    runs-on: ubuntu-latest
    needs: frontend
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š Install Backend Dependencies
      run: cd backend && npm ci
      
    - name: ğŸ§ª Run Backend Tests
      run: cd backend && npm run test || echo "Tests will be added"
      
    - name: ğŸ” Health Check Backend API
      run: |
        echo "Backend health check will be performed after Render deployment"
        # curl -f ${{ secrets.BACKEND_URL }}/api/health/live || exit 1

  # Notify Deployment Status
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [frontend, backend-check]
    if: always()
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.frontend.result == 'success' && needs.backend-check.result == 'success'
      run: |
        echo "âœ… YolNext Platform successfully deployed!"
        echo "ğŸ¨ Frontend: https://yolnext.netlify.app"
        echo "ğŸ”§ Backend: https://yolnext-backend.onrender.com"
        
    - name: ğŸ“¢ Failure Notification
      if: needs.frontend.result == 'failure' || needs.backend-check.result == 'failure'
      run: |
        echo "âŒ Deployment failed! Check logs for details."
        exit 1